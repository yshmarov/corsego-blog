---
layout: post
title: 'Ruby on Rails 6 Credentials: Quick guide'
author: Yaroslav Shmarov
tags: 
thumbnail: https://lh3.googleusercontent.com/-xhKge-mdtaQ/X4CcZss1yAI/AAAAAAACEqA/KGxnaNBdGNIJ9M0Vc3XgqEmhid8K3mgSgCLcBGAsYHQ/s72-w640-c-h318/image.png
---

<div><div class="separator" style="clear: both; text-align: left;">Often when working on a Rails app, you will have to handle vulnerable data.&nbsp;</div><div class="separator" style="clear: both; text-align: left;">Most often these are API keys to services that you integrate.</div><div class="separator" style="clear: both; text-align: left;">Most common examples:</div><div class="separator" style="clear: both; text-align: left;"><ul style="text-align: left;"><li>Github, Google, Twitter, Facebook oAuth&nbsp;</li><li>AWS S3&nbsp;</li><li>Stripe&nbsp;</li><li>Sendgrid</li></ul></div><div class="separator" style="clear: both; text-align: left;"><div class="separator" style="clear: both; text-align: center;"><a href="https://lh3.googleusercontent.com/-xhKge-mdtaQ/X4CcZss1yAI/AAAAAAACEqA/KGxnaNBdGNIJ9M0Vc3XgqEmhid8K3mgSgCLcBGAsYHQ/image.png" style="margin-left: 1em; margin-right: 1em;"><span style="color: black;"><img alt="Github oAuth API id and secret" data-original-height="1147" data-original-width="2311" height="318" src="https://lh3.googleusercontent.com/-xhKge-mdtaQ/X4CcZss1yAI/AAAAAAACEqA/KGxnaNBdGNIJ9M0Vc3XgqEmhid8K3mgSgCLcBGAsYHQ/w640-h318/image.png" title="Github oAuth API id and secret" width="640" /></span></a></div><div class="separator" style="clear: both; text-align: left;">On the image above you see a <b>client_id </b>and <b>client_secret </b>provided by Github, so that you can add "Log in with Github" functionality.</div><div class="separator" style="clear: both; text-align: left;">You could directly place these keys in your devise.rb file like</div></div><div class="separator" style="clear: both; text-align: left;"><table class="highlight tab-size js-file-line-container" data-paste-markdown-skip="" data-tab-size="8"><tbody><tr><td class="blob-code blob-code-inner js-file-line" id="LC261">  <span class="pl-s1">config</span><span class="pl-kos">.</span><span class="pl-en">omniauth</span> <span class="pl-pds">:<span class="pl-token" data-hydro-click-hmac="e6abd36fb4dd7939b475294bf703b9667d3e079e0841688bedd2fa5dd45e6518" data-hydro-click="{&quot;event_type&quot;:&quot;code_navigation.click_on_symbol&quot;,&quot;payload&quot;:{&quot;action&quot;:&quot;click_on_symbol&quot;,&quot;repository_id&quot;:264214812,&quot;ref&quot;:&quot;master&quot;,&quot;language&quot;:&quot;Ruby&quot;,&quot;originating_url&quot;:&quot;https://github.com/rormvp/corsego/blob/master/config/initializers/devise.rb&quot;,&quot;user_id&quot;:13472945}}">github</span></span><span class="pl-kos">,</span>&nbsp;"23r32t34t4rg", "<span class="pl-kos">regregbesgbvtegc4g43g343"</span></td>      </tr>      <tr>        </tr></tbody></table>However <b>this approach creates a security threat</b>. For example, if your repository is ever open sourced or shared with third parties, anybody can <b>misuse </b>your API keys.</div><div class="separator" style="clear: both; text-align: left;">That can lead to your account:</div><div class="separator" style="clear: both; text-align: left;"><ul style="text-align: left;"><li>being banned (overuse quota with too many requests)</li><li>charged (with your API keys anybody can upload child porn to your S3 account)</li><li>you can experience a data leak (all your application attachements from S3 can be leaked)</li></ul></div><div class="separator" style="clear: both; text-align: left;">That's why should use credentials to encrypt sensitive data. This way the line in devise.rb would look like:</div><div class="separator" style="clear: both; text-align: left;">```ruby</div><div class="separator" style="clear: both; text-align: left;">config.omniauth :github, (Rails.application.credentials[Rails.env.to_sym][:github][:client]).to_s, (Rails.application.credentials[Rails.env.to_sym][:github][:secret]).to_s</div><div class="separator" style="clear: both; text-align: left;">```</div><div class="separator" style="clear: both; text-align: left;">So how do you make it work?</div><div class="separator" style="clear: both; text-align: left;"><h2 style="clear: both;"><b style="background-color: #fcff01;">Let's start:</b></h2></div><div class="separator" style="clear: both; text-align: left;">When you create a Rails 6 app, under <b>app/config </b>you have a file named <b>credentials.yml.enc</b>:</div><div class="separator" style="clear: both; text-align: left;"><a href="https://lh3.googleusercontent.com/-4iZTLzxbncY/X4CaGZ2dEVI/AAAAAAACEpM/AsAq5WZQSM8AT8wVoHhYqJ4Mpjq8BJZAgCLcBGAsYHQ/image.png" style="margin-left: 1em; margin-right: 1em;"><span style="color: black;"><img alt="" data-original-height="751" data-original-width="314" height="240" src="https://lh3.googleusercontent.com/-4iZTLzxbncY/X4CaGZ2dEVI/AAAAAAACEpM/AsAq5WZQSM8AT8wVoHhYqJ4Mpjq8BJZAgCLcBGAsYHQ/image.png" width="100" /></span></a></div><div>If you open the <b>credentials.yml.enc </b>file, it will usually look like this:</div><div class="separator" style="clear: both; text-align: left;"><a href="https://lh3.googleusercontent.com/-KCyEccbImx4/X4CaUZcIxII/AAAAAAACEpU/r-ON0P8zTWkrRNsXUw65EAa68jG69c7VwCLcBGAsYHQ/image.png" style="margin-left: 1em; margin-right: 1em;"><span style="color: black;"><img alt="" data-original-height="184" data-original-width="1401" height="42" src="https://lh3.googleusercontent.com/-KCyEccbImx4/X4CaUZcIxII/AAAAAAACEpU/r-ON0P8zTWkrRNsXUw65EAa68jG69c7VwCLcBGAsYHQ/image.png" width="320" /></span></a></div><div>It is encrypted and safe to share with the public.</div><div><br /></div><div>To decrypt the&nbsp;<b>credentials.yml</b>&nbsp;file, the <b>master.key</b>&nbsp;file is used:</div><div class="separator" style="clear: both; text-align: left;"><a href="https://lh3.googleusercontent.com/-RUtndkpeMFk/X4CaQOERJII/AAAAAAACEpQ/JSo7npfdzvIqdjMnxFpdE4nZ7JEX9l7CQCLcBGAsYHQ/image.png" style="margin-left: 1em; margin-right: 1em;"><span style="color: black;"><img alt="" data-original-height="196" data-original-width="835" height="75" src="https://lh3.googleusercontent.com/-RUtndkpeMFk/X4CaQOERJII/AAAAAAACEpQ/JSo7npfdzvIqdjMnxFpdE4nZ7JEX9l7CQCLcBGAsYHQ/image.png" width="320" /></span></a></div><div><div><b style="background-color: #ea9999;">NEVER SHARE THE MASTER KEY WITH THE PUBLIC.</b></div></div><div><b style="background-color: #ea9999;">IF YOU LOSE THE MASTER KEY, YOU WILL NOT BE ABLE TO DECRYPT YOUR CREDENTIALS</b></div><div><div>By default, master.key is not included into your git commits.</div></div><div><br /></div><div>To decrypt and view or edit your&nbsp;<b>credentials.yml,</b>&nbsp;you can run&nbsp;</div><div><div>rails credentials:edit&nbsp;</div><div>or</div><div>EDITOR=vim rails credentials:edit</div></div><div><br /></div><div>When decripted, the&nbsp;<b>credentials.yml</b>&nbsp;file would typically looks somewhat like this:</div><div class="separator" style="clear: both; text-align: center;"><div class="separator" style="clear: both; text-align: left;"><div class="separator" style="clear: both; text-align: left;"><a href="https://lh3.googleusercontent.com/-yvlZCbZdMao/X4Cb8oZhQzI/AAAAAAACEpo/UJNm5vvRXp0nl6XYCAuHuBGea7py70TawCLcBGAsYHQ/image.png" style="margin-left: 1em; margin-right: 1em;"><span style="color: black;"><img alt="" data-original-height="622" data-original-width="1323" height="150" src="https://lh3.googleusercontent.com/-yvlZCbZdMao/X4Cb8oZhQzI/AAAAAAACEpo/UJNm5vvRXp0nl6XYCAuHuBGea7py70TawCLcBGAsYHQ/image.png" width="320" /></span></a></div><div class="separator" style="clear: both; text-align: left;">To retrieve any data from credentials.yml in your rails app or in the console, you can run something like</div><div class="separator" style="clear: both; text-align: left;">rails c</div><div class="separator" style="clear: both; text-align: left;">Rails.application.credentials.dig(:aws, :access_key_id)</div><div class="separator" style="clear: both; text-align: left;">#=&gt; Afwefwefwefwe......</div><div class="separator" style="clear: both; text-align: left;">Rails.application.credentials[:github][Rails.env.to_sym][:secret]</div><div class="separator" style="clear: both; text-align: left;"><div class="separator" style="clear: both;">#=&gt; 88d006fdb4.......</div><div><br /></div><div><div class="separator" style="clear: both;">Editing the file in VIM inside a terminal can a feel tricky and unnatural.&nbsp;</div></div><div>To edit the file, press "i". You will see "INSERT" appear on the bottom of the file, prompting that you are currently able to edit the file:</div></div><div class="separator" style="clear: both; text-align: left;"><div class="separator" style="clear: both; text-align: left;"><div class="separator" style="clear: both; text-align: left;"><a href="https://lh3.googleusercontent.com/-ReMOjlBhALY/X4Cb-qiYnHI/AAAAAAACEps/a110Wt8ptqINOJlJYuuKl6vXFhKApSt-ACLcBGAsYHQ/image.png" style="margin-left: 1em; margin-right: 1em;"><span style="color: black;"><img alt="" data-original-height="645" data-original-width="1319" height="156" src="https://lh3.googleusercontent.com/-ReMOjlBhALY/X4Cb-qiYnHI/AAAAAAACEps/a110Wt8ptqINOJlJYuuKl6vXFhKApSt-ACLcBGAsYHQ/image.png" width="320" /></span></a></div>When you're done, press ESC. next press ":wq" + ENTER to exit <b>with saving</b>.</div><div class="separator" style="clear: both; text-align: left;"><a href="https://lh3.googleusercontent.com/-aNSjidI2tII/X4CcD5biStI/AAAAAAACEp0/gJDjcYRp55I2hQipArqxjrKvoPy7XGxlgCLcBGAsYHQ/image.png" style="margin-left: 1em; margin-right: 1em; text-align: center;"><span style="color: black;"><img alt="" data-original-height="659" data-original-width="1312" height="161" src="https://lh3.googleusercontent.com/-aNSjidI2tII/X4CcD5biStI/AAAAAAACEp0/gJDjcYRp55I2hQipArqxjrKvoPy7XGxlgCLcBGAsYHQ/image.png" width="320" /></span></a></div></div></div><div style="text-align: left;">or press ESC + ":q!" + ENTER to exit <b>without saving</b>.</div><div style="text-align: left;"><a href="https://lh3.googleusercontent.com/-3-1RTHMcnGk/X4Cdqk1WMqI/AAAAAAACEqM/beGSoIDWlqQGahRxm1ssq-RClw9wQqrFQCLcBGAsYHQ/image.png" style="margin-left: 1em; margin-right: 1em; text-align: center;"><span style="color: black;"><img alt="" data-original-height="64" data-original-width="1329" height="15" src="https://lh3.googleusercontent.com/-3-1RTHMcnGk/X4Cdqk1WMqI/AAAAAAACEqM/beGSoIDWlqQGahRxm1ssq-RClw9wQqrFQCLcBGAsYHQ/image.png" width="320" /></span></a></div><div style="text-align: left;"><br /></div><div style="text-align: left;"><br /></div></div></div><div>**To set your master key in production (heroku example):**</div><div>heroku config:set RAILS_MASTER_KEY=123456789</div><div>or</div><div>heroku config:set RAILS_MASTER_KEY=`cat config/master.key`</div><div><br /></div><div><span style="background-color: #fcff01;"><b>That's all you need to know about credentials in Ruby on Rails. :)</b></span></div>