---
layout: post
title: 'How to use Credentials in Ruby on Rails 6? Full guide'
author: Yaroslav Shmarov
tags: 
- ruby on rails
- credentials
- secrets
thumbnail: data:image/png;base64,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
cover_image: /assets/thumbnails/how-to-use-credentials.png
description: Quickest guide to credentials and secrets for Rails 6
---

[See TLDR version of this article]({% post_url 2020-12-07-ruby-on-rails-6-credentials-tldr %}){:target="blank"}

Often when working on a Rails app, you will have to handle vulnerable data.

Most often these are API keys to services that you integrate.

Most common examples:

* Github, Google, Twitter, Facebook oAuth 
* AWS S3 
* Stripe, Braintree etc
* Sendgrid, Mailchimp etc

Here you can see a `client_id` and `client_secret` provided by Github, so that you can add **"Log in with Github"** functionality:

![1-github-credentials](assets/2020-12-07-ruby-on-rails-6-credentials-quick-guide/1-github-credentials.png)

To use these keys, you could directly place them in your `devise.rb` file like
```
config.omniauth :github, "23r32t34t4rg", "regregbesgbvtegc4g43g343"
```
However this approach creates a security threat. 

For example, if your repository is ever open sourced or shared with third parties, anybody can misuse your API keys.

That can lead to your account:

* being banned (overuse quota with too many requests)
* charged (with your API keys anybody can upload too much data to your S3 account)
* you can experience a data leak (all your application attachements from S3 can be leaked)

That's why should use credentials to encrypt sensitive data. 

An **encrypted** line in `devise.rb` would look like:
```
config.omniauth :github, (Rails.application.credentials[Rails.env.to_sym][:github][:client]).to_s, (Rails.application.credentials[Rails.env.to_sym][:github][:secret]).to_s
```
So how do you make it work?

# Let's start:

When you create a Rails 6 app, under app/config you have a file named `credentials.yml.enc`:

![2-credentials-config](assets/2020-12-07-ruby-on-rails-6-credentials-quick-guide/2-credentials-config.png)

If you open the `credentials.yml.enc` file, it will usually look like this:

![3-credentials-yml-open](assets/2020-12-07-ruby-on-rails-6-credentials-quick-guide/3-credentials-yml-open.png)

It is encrypted and safe to share in a public repository.

To decrypt the `credentials.yml` file, the `master.key` file is used:

![4-master-key-open](assets/2020-12-07-ruby-on-rails-6-credentials-quick-guide/4-master-key-open.png)

**NEVER SHARE THE MASTER KEY WITH THE PUBLIC.**

**IF YOU LOSE THE MASTER KEY, YOU WILL NOT BE ABLE TO DECRYPT YOUR CREDENTIALS**

By default, `master.key` is not included into your git commits.

To decrypt and view or edit your `credentials.yml`, 
you can run `rails credentials:edit` 
or `EDITOR=vim rails credentials:edit`.

When decripted, the `credentials.yml` file would typically looks somewhat like this:

![5-opened-credentials](assets/2020-12-07-ruby-on-rails-6-credentials-quick-guide/5-opened-credentials.png)

To retrieve any data from `credentials.yml` in your rails app or in the console, you can run something like
```
rails c
Rails.application.credentials.dig(:aws, :access_key_id)
#=> sdgb89dngfm6cg8jmbdb8f9bfg6n8fnd7bd9f
Rails.application.credentials[:github][Rails.env.to_sym][:secret]
#=> 6hl65knh4l5vgm8
```
Editing the file in VIM inside a terminal can a feel tricky and unnatural. 

To edit the file, press `i`. You will see `INSERT` appear on the bottom of the file, prompting that you are currently able to edit the file:

![6-credentials-insert](assets/2020-12-07-ruby-on-rails-6-credentials-quick-guide/6-credentials-insert.png)

When you're done, press `ESC`. next press `:wq` + `ENTER` to exit with saving.

![7-credentials-save](assets/2020-12-07-ruby-on-rails-6-credentials-quick-guide/7-credentials-save.png)

or press `ESC` + `:q!` + `ENTER` to exit without saving.

![8-credentials-no-save](assets/2020-12-07-ruby-on-rails-6-credentials-quick-guide/8-credentials-no-save.png)

**To set your master key in production (heroku example):**
```
heroku config:set RAILS_MASTER_KEY=YOURMASTERKEY
```
or
```
heroku config:set RAILS_MASTER_KEY=`cat config/master.key`
```

That's it :)
