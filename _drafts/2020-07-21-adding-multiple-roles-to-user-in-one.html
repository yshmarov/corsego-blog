---
layout: post
title: Adding multiple roles to a user in one field
date: '2020-07-21T23:49:00.000+02:00'
author: yaro_the_slav
tags: 
modified_time: '2020-07-21T23:49:27.708+02:00'
blogger_id: tag:blogger.com,1999:blog-5936476238571675194.post-3027332309286193552
blogger_orig_url: https://blog.corsego.com/2020/07/adding-multiple-roles-to-user-in-one.html
---

<br /><br />Helpful materials:<br /><a href="https://melvinchng.github.io/rails/RailsJSONB.html#43-use-jsonb-column-to-in-form">https://melvinchng.github.io/rails/RailsJSONB.html#43-use-jsonb-column-to-in-form</a><br /><br /><a href="https://nandovieira.com/using-postgresql-and-jsonb-with-ruby-on-rails">https://nandovieira.com/using-postgresql-and-jsonb-with-ruby-on-rails</a> <br /><a href="https://www.blogger.com/u/1/goog_974497400"><br /></a><a href="https://guides.rubyonrails.org/active_record_postgresql.html#json-and-jsonb">https://guides.rubyonrails.org/active_record_postgresql.html#json-and-jsonb</a><br /><br />rails hash<br /><a href="https://ruby-doc.org/core-2.5.1/Hash.html">https://ruby-doc.org/core-2.5.1/Hash.html</a><br /><br /><b>migration:</b><br /><br />class AddRolesToUsers &lt; ActiveRecord::Migration[6.0]<br />&nbsp; def change<br />&nbsp;&nbsp;&nbsp; add_column :users, :roles, :jsonb, null: false, default: {}<br />&nbsp;&nbsp;&nbsp; add_index&nbsp; :users, :roles, using: :gin<br />&nbsp; end<br />end<br /><br /><br /><b>member.rb</b><br /><br />&nbsp; # List user roles<br />&nbsp; ROLES = [:admin, :viewer]<br /><br />&nbsp; # json column to store roles <br />&nbsp; store_accessor :roles, *ROLES<br /><br />&nbsp; # Cast roles to/from booleans<br />&nbsp; ROLES.each do |role|<br />&nbsp;&nbsp;&nbsp; scope role, -&gt; { where("roles @&gt; ?", {role =&gt; true}.to_json) }<br />&nbsp;&nbsp;&nbsp; define_method(:"#{role}=") { |value| super ActiveRecord::Type::Boolean.new.cast(value) }<br />&nbsp;&nbsp;&nbsp; define_method(:"#{role}?") { send(role) }<br />&nbsp; end<br /><br />&nbsp; def active_roles # Where value true<br />&nbsp;&nbsp;&nbsp; ROLES.select { |role| send(:"#{role}?") }.compact<br />&nbsp; end<br /><br /><b>controller whitelist</b><br /><br />&nbsp;&nbsp;&nbsp; def user_params<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; params.require(:user).permit(*User::ROLES)<br />&nbsp;&nbsp;&nbsp; end<br /><b><br /></b><b>form</b><br /><br />&nbsp; &lt;div class="form-group"&gt;<br />&nbsp;&nbsp;&nbsp; &lt;% User::ROLES.each do |role| %&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;label&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;%= f.check_box role %&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;%= role.to_s.humanize %&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/label&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;br&gt;<br />&nbsp;&nbsp;&nbsp; &lt;% end %&gt;<br />&nbsp; &lt;/div&gt;<br /><br /><b>list roles in a view</b><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;%= user.active_roles.join(", ") %&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;%= user.roles %&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;%= user.roles.class %&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;%= user.admin? %&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;% if user.admin? || user.viewer? %&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; admin or viewer<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;% end %&gt;<br /><br />f<br /><div style="font-family: Calibri; font-size: 11.0pt; margin-left: .375in; margin: 0in;"><span style="font-weight: bold;">&lt;%= current_user.admin? %&gt;</span></div><br />controller validation <br /><br />  <br /><div style="font-family: Calibri; font-size: 11.0pt; margin-left: .375in; margin: 0in;"><span style="font-weight: bold;"><span style="mso-spacerun: yes;">&nbsp; </span>before_action :only_admin, only: [:index]</span></div><div style="font-family: Calibri; font-size: 11.0pt; margin-left: .375in; margin: 0in;"><span style="font-weight: bold;"><span style="mso-spacerun: yes;">&nbsp; </span>def only_admin</span></div><div style="font-family: Calibri; font-size: 11.0pt; margin-left: .375in; margin: 0in;"><span style="font-weight: bold;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>current_member = Member.where(user: current_user).first</span></div><div style="font-family: Calibri; font-size: 11.0pt; margin-left: .375in; margin: 0in;"><span style="font-weight: bold;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>unless current_member.admin?</span></div><div style="font-family: Calibri; font-size: 11.0pt; margin-left: .375in; margin: 0in;"><span style="font-weight: bold;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>redirect_to dashboard_path, notice: "Not authorized!"</span></div><div style="font-family: Calibri; font-size: 11.0pt; margin-left: .375in; margin: 0in;"><span style="font-weight: bold;"><span style="mso-spacerun: yes;">&nbsp;&nbsp;&nbsp; </span>end</span></div><div style="font-family: Calibri; font-size: 11.0pt; margin-left: .375in; margin: 0in;"><span style="font-weight: bold;"><span style="mso-spacerun: yes;">&nbsp; </span>end</span></div><br />